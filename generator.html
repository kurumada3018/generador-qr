<!-- ... (Mantener estilos del encabezado igual) ... -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="qrcode.min.js"></script>

<!-- ... (Mantener HTML igual) ... -->

<script>
    // CONFIGURACIÓN - CAMBIA ESTO
    const SECRET_KEY = "Colombia2026//"; // Debe ser igual en el verificador
    const USERS_LIST_URL = 'https://gist.githubusercontent.com/kurumada3018/2348f46cc2f7fd407687b1ddd72b8398/raw/79fd77d6d8be1d8332c62288a63ce8bab783e9a8/usuarios_generador.json';

    let currentUser = null;
    const loginForm = document.getElementById('login-form');
    // ... (Mantener lógica de hashPassword y loginForm.addEventListener igual) ...

    accessForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const fechaExpInput = document.getElementById('fecha-exp').value;
        let expirationTimestamp = 0;

        if (fechaExpInput) {
            const expirationDate = new Date(fechaExpInput + 'T23:59:59');
            expirationTimestamp = expirationDate.getTime();
        }

        // Objeto con la información
        const data = {
            n: document.getElementById('nombre').value,
            id: document.getElementById('id').value,
            v: {
                t: document.getElementById('vehiculo').value,
                m: document.getElementById('modelo').value,
                p: document.getElementById('placa').value
            },
            e: "A",
            f: new Date().toLocaleDateString('es-ES'),
            c: currentUser,
            exp: expirationTimestamp,
            park: document.getElementById('parqueadero').value
        };

        // --- ENCRIPTACIÓN ---
        const dataString = JSON.stringify(data);
        // Ciframos el JSON antes de meterlo al QR
        const encryptedData = CryptoJS.AES.encrypt(dataString, SECRET_KEY).toString();

        const qrCodeContainer = document.getElementById('qrcode');
        qrCodeContainer.innerHTML = '';
        
        // El QR ahora solo contiene el texto cifrado
        new QRCode(qrCodeContainer, { 
            text: encryptedData, 
            width: 256, 
            height: 256, 
            correctLevel: QRCode.CorrectLevel.M 
        });
        
        setTimeout(() => {
            const qrImage = qrCodeContainer.querySelector('img');
            const downloadLink = document.getElementById('download-link');
            if (qrImage) {
                downloadLink.href = qrImage.src;
                downloadLink.download = `QR_Acceso_${data.n.replace(/\s/g, '_')}.png`;
                downloadLink.style.display = 'block';
            }
        }, 500);
    });
</script>

