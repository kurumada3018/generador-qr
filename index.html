<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador QR - Sistema de Seguridad</title>
    
    <!-- Librerías de confianza -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background: #1a1a2e url('IMG_8196.jpg') no-repeat center center fixed;
            background-size: cover;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #main-container {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 450px;
            width: 90%;
        }

        h1 { text-align: center; color: #0f3460; font-size: 22px; margin-bottom: 20px; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px; }
        input { 
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;
            box-sizing: border-box; font-size: 14px;
        }
        button { 
            width: 100%; padding: 12px; background-color: #e94560; color: white; 
            border: none; border-radius: 6px; font-size: 16px; font-weight: bold;
            cursor: pointer; margin-top: 10px; transition: 0.3s;
        }
        button:hover { background-color: #c62a48; }
        
        #qrcode-container { 
            text-align: center; margin-top: 20px; 
            padding: 15px; background: #f9f9f9; border-radius: 10px;
        }
        canvas { max-width: 100%; height: auto; border: 1px solid #ddd; }
        #download-btn { 
            display: none; margin-top: 15px; background-color: #0f3460;
            text-decoration: none; color: white; padding: 10px; 
            border-radius: 6px; font-size: 14px; text-align: center;
        }
        #login-error { color: #e94560; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

    <div id="main-container">
        <!-- LOGIN -->
        <div id="login-container">
            <h1>Acceso Administrador</h1>
            <form id="login-form">
                <div class="form-group"><label>Usuario:</label><input type="text" id="username" required></div>
                <div class="form-group"><label>Contraseña:</label><input type="password" id="password" required></div>
                <button type="submit">ENTRAR</button>
                <p id="login-error"></p>
            </form>
        </div>

        <!-- GENERADOR -->
        <div id="generator-container" style="display:none;">
            <h1>Generar Acceso QR</h1>
            <form id="access-form">
                <div class="form-group"><label>Nombre del Visitante:</label><input type="text" id="nombre" required></div>
                <div class="form-group"><label>Cédula / ID:</label><input type="text" id="id" required></div>
                <div class="form-group"><label>Placa Vehículo:</label><input type="text" id="placa" required></div>
                <div class="form-group"><label>Fecha Expiración (Opcional):</label><input type="date" id="fecha-exp"></div>
                <button type="submit">GENERAR CÓDIGO SEGURO</button>
            </form>

            <div id="qrcode-container">
                <canvas id="qr-canvas"></canvas>
                <a id="download-btn">DESCARGAR CÓDIGO QR</a>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN CRÍTICA ---
        const SECRET_KEY = "PON_AQUI_TU_LLAVE_MISMOS_CARACTERES"; 
        const USERS_URL = 'https://gist.githubusercontent.com/kurumada3018/2348f46cc2f7fd407687b1ddd72b8398/raw/79fd77d6d8be1d8332c62288a63ce8bab783e9a8/usuarios_generador.json';

        let adminUser = "";

        // Función para validar contraseña
        async function hashString(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Manejo de Login
        document.getElementById('login-form').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const hashed = await hashString(p);

            try {
                const res = await fetch(USERS_URL + '?t=' + Date.now());
                const users = await res.json();
                if (users[u] && users[u] === hashed) {
                    adminUser = u;
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('generator-container').style.display = 'block';
                } else {
                    document.getElementById('login-error').innerText = "Credenciales Incorrectas";
                }
            } catch(err) { alert("Error al conectar con la base de datos de usuarios"); }
        };

        // Manejo de Generación de QR
        document.getElementById('access-form').onsubmit = (e) => {
            e.preventDefault();
            
            const expInput = document.getElementById('fecha-exp').value;
            const expiration = expInput ? new Date(expInput + 'T23:59:59').getTime() : 0;

            const rawData = {
                n: document.getElementById('nombre').value,
                id: document.getElementById('id').value,
                v: { p: document.getElementById('placa').value },
                exp: expiration,
                c: adminUser,
                f: new Date().toLocaleDateString()
            };

            try {
                // 1. Encriptar
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(rawData), SECRET_KEY).toString();

                // 2. Generar QR en el Canvas
                const qr = new QRious({
                    element: document.getElementById('qr-canvas'),
                    value: encrypted,
                    size: 300,
                    level: 'M' // Calidad media para soportar más datos
                });

                // 3. Habilitar Descarga
                const btn = document.getElementById('download-btn');
                btn.href = document.getElementById('qr-canvas').toDataURL("image/png");
                btn.download = `QR_${rawData.n}.png`;
                btn.style.display = "block";

            } catch (err) {
                console.error(err);
                alert("Error al generar el QR. Intenta con menos texto.");
            }
        };
    </script>
</body>
</html>
